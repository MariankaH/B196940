---
title: "Assessment"
author: "Mary Hronska"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction

It this report, I will analyse trends in ADHD medication prescriptions in the UK by comparing data from the pre-COVID-19 period and post-COVID-19 period. The focus is on the number of prescribed doses per capita, which will allow us to see changes over this period. The aim of this report is to answer the question: Has there been an increase in ADHD medication prescription related to COVID-19?

The motivation behind this comparison arises from observations and discussions suggesting that the pandemic lockdowns, which forced people to study and work from home, might have negatively affected their attention span. This report aims to investigate whether there was a a rise in ADHD prescriptions that could reflect an increase in attention-related challenges following pandemic lockdowns.

## Adding libraries

```{r libraries}
library(tidyverse)
library(janitor)
library(sf)
library(gt)
library(here)
library(kableExtra)
library(patchwork)
library(rjson)
```

# Load data and filter for ADHD medications

I filtered the data to only contain rows with Methylphenidate, Lisdexamfetamine, Dexamfetamine, Atomoxetine, and Guanfacine. These are the only drugs that have been licensed for the treatment of ADHD in the UK by NHS.

```{r 5 years dataframe}
# if the file "prescriptions.csv" does not exist in the data folder, create it and save it into the data folder
if (!file.exists(file = here("data", "prescriptions.csv"))) {
  json <- fromJSON(file = "https://www.opendata.nhs.scot/api/3/action/package_show?id=prescriptions-in-the-community")
  
  # get all the URLs of the dataframes from the json file
  urls <- data.frame(url = unlist(map(json$result$resources, function(resource){resource$url}))) %>% 
    # filter for datasets that are set between August 2019 and August 2024
    mutate(date = as.numeric(str_extract(url, "/pitc(\\d+)\\.csv$", group = 1))) %>% 
    filter(date > 201812 & date < 202409)
  
  # read the dataframes from URLs and filter for the 5 types of medications licensed for the treatment of ADHD by the NHS
  prescriptions <- lapply(urls$url, function(x){
    read_csv(x) %>% 
      filter(str_detect(BNFItemDescription, "METHYLPHENIDATE|LISDEXAMFETAMINE|DEXAMFETAMINE|ATOMOXETINE|GUANFACINE")) %>% 
      clean_names()
  })

  test9 <- list()
  test10 <- list()
  
  # divide dataframes into two groups according to the number of columns (9 or 10)
  for (dataframe in prescriptions) {
    if (ncol(dataframe) == 9) {
      # change the name of the "hbt2014" column into "hbt" in dataframes from the year 2019
      if ("hbt2014" %in% names(dataframe)) {
        dataframe <- rename(dataframe, "hbt" = "hbt2014")
      }
      test9 <- append(test9, list(dataframe))
    } else if (ncol(dataframe) == 10) {
      test10 <- append(test10, list(dataframe))
    }
  }
  
  # join the two groups of dataframes into one dataframe
  prescriptions <- full_join(do.call(rbind, test9), do.call(rbind, test10))
  
  # save the dataframe into the data file
  write_csv(prescriptions, file = here("data", "prescriptions.csv"))
} else {
  prescriptions <- read.csv(here("data", "prescriptions.csv"))
}
```

# Look at the 5 year overview of prescriptions of ADHD medications

```{r figure 1}
# get a sum of prescribed doses of the 5 types of ADHD medications per month
overview <- prescriptions %>%
  mutate(bnf_item_description = word(bnf_item_description, sep = "[ _]"),
         paid_date_month = ym(paid_date_month)) %>%
  group_by(bnf_item_description, paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity))

# a graph of the number of prescribed doses of ADHD medication from Jan 2019 to Aug 2024
overview_normal <- overview %>% 
  ggplot(aes(x = paid_date_month, y = paid_quantity, colour = bnf_item_description)) +
  geom_line() +
  theme_bw() +
  labs(title = "Number of Prescribed Doses of 5 Types of ADHD Medications from January 2019 to August 2024",
       x = "Time (Years)",
       y = "Number of prescribed doses")

# the same graph but on a log scale
overview_log <- overview %>% 
  ggplot(aes(x = paid_date_month, y = log(paid_quantity), colour = bnf_item_description)) +
  geom_line() +
  theme_bw() +
  labs(x = "Time (Years)",
       y = "Log of number of prescribed doses")

(overview_normal + overview_log) +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom',
                                          legend.title = element_blank(),
                                          plot.title=element_text(size=10),
                                          legend.text=element_text(size=7.5))
```

The data indicate that Methylphenidate has shown the highest increase in prescriptions over the years. Although Atomoxetine, Dexamfetamine, and Guanfacine have also seen a steady rise, their growth is not as pronounced as that of Methylphenidate. Notably, in May 2023, prescriptions for Atomoxetine and Dexamfetamine declined, coinciding with the introduction of Lisdexamfetamine to the market. This suggests that Lisdexamfetamine replaced Atomoxetine and Dexamfetamine on the market.

# Differences of ADHD prescriptions per capita in Scottish Health Boards in 2019 and 2023

To further investigate the increase in ADHD medications in Scotland, I want to look at differences in individual Scottish Health Boards.

## Load data and filter for year 2020 and 2023

To compare the number of prescribed doses of ADHD medication before and after COVID-19, I will account for population differences across Scottish health boards. For the pre-COVID comparison, I used 2019 population data to reflect the population just before the first lockdown. For the post-COVID period, I selected 2023 as a reference, as the full data for 2024 is not yet available.

```{r population dataframes}
# ref: https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_14102024.csv

hb_population <- read_csv(here("data", "hb_population.csv"))

population_2019 <- hb_population %>% 
  filter(Year == "2019")

population_2023 <- hb_population %>% 
  filter(Year == "2023")
```

## Load NSH health boards shapefile

```{r NHS healthboards}
NHS_healthboards <- st_read(here("data", "NHS_healthboards_2019.shp"))
```

## Join the prescription dataframe with population file and the shapefile.

```{r joining dataframes}
year_2019 <- prescriptions %>%
  filter(str_detect(paid_date_month, "2019")) %>% 
  group_by(hbt) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  full_join(population_2019, by = c("hbt" = "HB")) %>% 
  filter(Sex == "All") %>% 
  select(c(hbt, paid_quantity, AllAges)) %>% 
  filter(!is.na(paid_quantity)) %>%
  mutate(ratio = paid_quantity / AllAges,
         year = "2019") %>% 
  full_join(NHS_healthboards, by = c("hbt" = "HBCode"))

year_2023 <- prescriptions %>%
  filter(str_detect(paid_date_month, "2023")) %>% 
  group_by(hbt) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  full_join(population_2023, by = c("hbt" = "HB")) %>% 
  filter(Sex == "All") %>% 
  select(c(hbt, paid_quantity, AllAges)) %>% 
  filter(!is.na(paid_quantity)) %>%
  mutate(ratio = paid_quantity / AllAges,
         year = "2023") %>% 
  full_join(NHS_healthboards, by = c("hbt" = "HBCode"))
```

## Map of ADHD prescriptions per capita in 2019 and 2023

```{r map of scotland}
map_data <- full_join(year_2019, year_2023)

map_data %>% 
  ggplot(aes(fill = ratio)) +
  geom_sf(aes(geometry = geometry)) +
  scale_fill_distiller(palette = 16, direction = 1) + 
  theme_bw() +
  theme(plot.title=element_text(size=11)) +
  facet_wrap(~year) +
  labs(title = "Ratio of Number of Prescribed Doses of ADHD Medication and Health Board Population")
```

Seems like the ratio of population to number of doses of medication is higher in most health boards in Scotland. The only health board that decreased in their number of prescribed doses of ADHD medication is Tayside which went down from 1.02 to 0.904. Grampian has a ratio of 1.33, which is the highest ratio of number of prescribed doses of ADHD medication per person.

## Future plan

To provide a comprehensive overview, I plan to include a table displaying the annual number of prescribed doses for each of the five ADHD medications, alongside the population of Scotland and the ratio of doses per person. This table will be placed between Figure 1 and Figure 2.

Figure 1 illustrates an increase in ADHD medication prescriptions over time, but it does not account for potential population growth. By incorporating the table, I aim to clarify whether the observed rise in prescriptions is proportionate to, or exceeds, population growth. This additional data will help contextualize the trends and provide a more accurate understanding of the changes in prescription rates.

Afterwards, I would give more insight into Figure 2 and explore more of the data it provides about the different Scottish Health Boards.