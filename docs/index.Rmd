---
title: "Assessment"
author: "Mary Hronska"
date: "2024-11-01"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    number_sections: true
    highlight: tango
  pdf_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

<style>
body {
text-align: justify}
</style>

# Introduction

Attention Deficit Hyperactivity Disorder (ADHD), known for low attention span and hyperactivity, has been a centre of attention in research and public discourse for a long time (Toplak *et al.*, 2006). The prevalence of people diagnosed with ADHD increases yearly and, notably, there was a significant global increase in ADHD symptoms following the COVID-19 pandemic (Rogers *et al.*, 2023). It is thought that the pandemic lockdowns, which forced people to study and work from home, had negatively affected their attention span.

It this report, I will analyse trends in ADHD medication prescriptions in Scotland by comparing data from the pre-COVID-19 period and post-COVID-19 period. The focus is on the number of prescribed doses, which will allow us to see changes over this period. The aim of this report is to answer the question: **Has there been an increase in ADHD medication prescription that could reflect an increase in attention-related challenges following pandemic lockdowns?**

# Aims

The overall aim is to uncover trends in ADHD medication prescription in Scotland pre- and post-COVID-19 lockdowns. The report will show:

1. An overview of ADHD medication prescriptions from January 2019 to August 2024
    + Is there an **increasing trend** in ADHD medication prescription?
    + Which type of ADHD medication is the **most common**?
2. A map of overall prescriptions in the year 2019 (pre-COVID-19 lockdowns) and the year 2023 (post-COVID-19 lockdowns).
    + What is the trend of ADHD medication prescription between the **different regions of Scotland**?
    + Which regions of Scotland saw the **highest increase** in ADHD medication prescription?
3. A table of most prescribed ADHD medications in the past year in Lothian area.
    + Which type and what dosage of ADHD medication is the **most common now**?

# Report
## ADHD medications licensed by NHS

There are 5 ADHD medications that have been licensed for the treatment of ADHD in the UK by [NHS](https://www.nhs.uk/conditions/attention-deficit-hyperactivity-disorder-adhd/treatment/). These medications are:

* Atomoxetine
* Dexamfetamine
* Guangacine
* Lisdexamfetamine
* Methylphenidate

### Load packages

```{r packages}
# load packages using shelf function from librarian package
librarian::shelf(tidyverse, janitor, sf, here, kableExtra, gt, patchwork, rjson, plotly)
```

### Load data and filter for ADHD medications

```{r 5 years dataframe}
# if the file "prescriptions.csv" does not exist in the data folder, create it and save it into the data folder
if (!file.exists(file = here("data", "prescriptions.csv"))) {
  json <- fromJSON(file = "https://www.opendata.nhs.scot/api/3/action/package_show?id=prescriptions-in-the-community")
  
  # get all the URLs of the dataframes from the json file
  urls <- data.frame(url = unlist(map(json$result$resources, function(resource){resource$url}))) %>% 
    # filter for dataframes that are set between January 2019 and August 2024
    mutate(date = as.numeric(str_extract(url, "/pitc(\\d+)\\.csv$", group = 1))) %>% 
    filter(date > 201812 & date < 202409)
  
  # read the dataframes from URLs and filter for the 5 types of medications licensed for the treatment of ADHD by the NHS
  prescriptions <- lapply(urls$url, function(url){
    read_csv(url) %>% 
      clean_names() %>% 
      filter(str_detect(bnf_item_description, "ATOMOXETINE|DEXAMFETAMINE|GUANFACINE|LISDEXAMFETAMINE|METHYLPHENIDATE")) %>% 
      # change the name of the "hbt2014" column into "hbt" in dataframes from the year 2019
      rename(any_of(c("hbt" = "hbt2014"))) %>%
      mutate(medication_name = word(bnf_item_description, sep = "[ _]"),
             dose = word(bnf_item_description, start = 2, end = -1, sep = "[ _]")) %>% 
      select(hbt, medication_name, dose, number_of_paid_items, paid_quantity, paid_date_month)
  })

  # join all dataframes into one dataframe
  prescriptions <- prescriptions %>% 
    reduce(full_join)
  
  # save the dataframe into the data file
  write_csv(prescriptions, file = here("data", "prescriptions.csv"))
} else {
  prescriptions <- read.csv(here("data", "prescriptions.csv"))
}
```

### Look at the 5 year overview of prescriptions of ADHD medications

```{r figure 1, fig.width=8}
# get a sum of prescribed doses of the 5 types of ADHD medications per month
overview <- prescriptions %>%
  mutate(paid_date_month = ym(paid_date_month)) %>%
  group_by(medication_name, paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity))

# create a function that creates a line graph with changeable y axis title, y axis type, and visibility of legend
create_graph <- function(y_title, y_type = NULL, show_legend = FALSE) {
  overview %>%
    plot_ly(x = ~paid_date_month,
            y = ~paid_quantity,
            type = "scatter",
            mode = "lines",
            split = ~medication_name,
            color = ~medication_name,
            legendgroup = ~medication_name,
            showlegend = show_legend) %>%
    layout(xaxis = list(title = "Date (month and year)"),
           yaxis = list(title = y_title, type = y_type))
}

# create a normal graph and a log graph
overview_normal <- create_graph("Number of prescribed medications")
overview_log <- create_graph("Log of number of prescribed medications", "log", TRUE)

# join the two graphs and tinker with some label title and legend settings
subplot(overview_normal, overview_log, shareX = TRUE, titleX = TRUE, titleY = TRUE, margin = 0.05) %>% 
  layout(title = "Number of Prescribed Doses of 5 Types of ADHD Medications<br>from January 2019 to August 2024",
         hovermode = "x unified",
         legend = list(orientation = 'h', y = -0.2, borderwidth = 1, bordercolor = "black", xanchor = "center", x = 0.5))
```

The data indicate that Methylphenidate has shown the highest increase in prescriptions over the years. Although Atomoxetine, Dexamfetamine, and Guanfacine have also seen a steady rise, their growth is not as pronounced as that of Methylphenidate. Notably, in May 2023, prescriptions for Atomoxetine and Dexamfetamine declined, coinciding with the introduction of Lisdexamfetamine to the market. This suggests that Lisdexamfetamine replaced Atomoxetine and Dexamfetamine on the market.

## Differences of ADHD prescriptions per capita in Scottish Health Boards in 2019 and 2023

To further explore the increase in ADHD medication prescriptions in Scotland, I will compare the number of prescribed doses before and after the COVID-19 pandemic. This analysis will also account for population differences across Scottish Health Boards. For the pre-COVID comparison, I will use 2019 population data, representing the year just before the first lockdown. For the post-COVID period, 2023 will be the reference year, as complete data for 2024 is not yet available.

### Load dataframes with Scottish Health Board names, populations, and shapefile

```{r health board data, results='hide'}
# ref: https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv
hb_names <- read_csv(here("data", "hb_names.csv")) %>% 
  clean_names() %>% 
  select(hb, hb_name)

# ref: https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_14102024.csv
hb_population <- read_csv(here("data", "hb_population.csv")) %>% 
  clean_names() %>% 
  filter(sex == "All") %>% 
  select(year, hb, all_ages)

# ref: "https://maps.gov.scot/ATOM/shapefiles/SG_NHS_HealthBoards_2019.zip"
NHS_healthboards <- st_read(here("data", "NHS_healthboards_2019.shp"))
```

### Join the prescription dataframe with population file and the shapefile
```{r}
map_data <- prescriptions %>% 
  mutate(paid_date_month = year(ym(paid_date_month))) %>% 
  full_join(hb_population, by = c("hbt" = "hb", "paid_date_month" = "year")) %>% 
  filter(paid_date_month %in% c("2019", "2023"),
         !(hbt %in% c("S92000003", "S08000021", "S08000023"))) %>% 
  group_by(hbt, all_ages, paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  mutate(ratio = paid_quantity / all_ages) %>% 
  full_join(NHS_healthboards, by = c("hbt" = "HBCode"))
```

### Map of ADHD prescriptions per capita in 2019 and 2023

```{r map of scotland TEST}
map_figure <- map_data %>% 
  ggplot() +
  geom_sf(aes(fill = ratio, geometry = geometry, text = paste(HBName, "had a ratio of", format(ratio, digits = 2), "in", paid_date_month)), lwd = 0.1) +
  scale_fill_distiller(palette = 16, direction = 1) + 
  theme_void() +
  theme(plot.title = element_text(size=11)) +
  facet_wrap(~paid_date_month) +
  labs(title = "Ratio of Number of Prescribed Doses of ADHD Medication and Health Board Population")

map_figure %>%
  ggplotly(tooltip = "text") %>%
  style(hoverlabel = list(bgcolor = "white"), hoveron = "fill")
```

Seems like the ratio of population to number of doses of medication is higher in most health boards in Scotland. The only health board that decreased in their number of prescribed doses of ADHD medication is Tayside which went down from 1.02 to 0.904. Grampian has a ratio of 1.33, which is the highest ratio of number of prescribed doses of ADHD medication per person.

### Table

```{r table}
past_year_prescriptions <- prescriptions %>%
  filter(paid_date_month > 202308 & paid_date_month < 202409) %>% 
  full_join(hb_names, by = c("hbt" = "hb")) %>% 
  full_join(hb_population %>% filter(year == "2023"), by = c("hbt" = "hb")) %>% 
  filter(hb_name == "NHS Lothian") %>% 
  group_by(medication_name, dose, all_ages) %>% 
  summarise(paid_quantity = sum(paid_quantity),
            number_of_paid_items = sum(number_of_paid_items)) %>% 
  mutate(paid_quantity = (paid_quantity / all_ages) * 10000,
         number_of_paid_items = (number_of_paid_items / all_ages) * 10000) %>% 
  ungroup()

past_year_prescriptions %>% 
  select(medication_name, dose, number_of_paid_items, paid_quantity) %>% 
  group_by(medication_name) %>% 
  slice_max(paid_quantity, n = 3) %>%
  arrange(desc(paid_quantity)) %>%
  
  gt() %>% 
  tab_header(title = "Top 3 Most Prescribed ADHD Medications of Each Type in The Past Year",
             subtitle = "Data from NHS Lothian") %>% 
  tab_style(style = cell_text(weight = "bold"),
            locations = list(cells_title(groups = "title"), cells_row_groups(groups = everything()))) %>%
  
  tab_spanner(label = "Rate per 10k population",
              columns = c(number_of_paid_items, paid_quantity)) %>% 
  tab_style(style = cell_text(style = "italic"),
            locations = cells_column_spanners(spanners = everything())) %>% 
  
  cols_label(medication_name = "Medication Name",
             dose = "Dose",
             number_of_paid_items = "Number of Paid Items",
             paid_quantity = "Number of Prescriptions") %>% 
  
  fmt_number(columns = c(number_of_paid_items, paid_quantity), decimals = 2) %>% 
  
  summary_rows(columns = c(number_of_paid_items, paid_quantity), 
               fns = list("Average" = ~mean(., na.rm = TRUE)),
               fmt = list(~ fmt_number(., decimals = 2))) %>% 
  grand_summary_rows(columns = c(number_of_paid_items, paid_quantity), 
                     fns = list("Overall Average" = ~mean(., na.rm = TRUE)),
                     fmt = list(~ fmt_number(., decimals = 2))) %>% 
  
  opt_row_striping()
  
```
# Conclusion

Here will be a conclusion soon.

# References

Rogers, M.A. and MacLean, J. (2023) ‘ADHD symptoms increased during the COVID-19 pandemic: A meta-analysis’, *Journal of Attention Disorders*, 27(8), pp. 800–811. doi:10.1177/10870547231158750. 

Toplak, M.E., Dockstader, C., Tannock, R. (2006) ‘Temporal information processing in ADHD: Findings to date and New Methods’, *Journal of Neuroscience Methods*, 151(1), pp. 15–29. doi:10.1016/j.jneumeth.2005.09.018.